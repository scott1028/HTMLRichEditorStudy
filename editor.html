<!DOCTYPE html>
<html>
<head>
    <title></title>
</head>
<body>
    <button onclick="bClick(this)">B</button>
    <button onclick="bClick2(this)">B2</button>
    <button onclick="uClick(this)">U</button>
    <button>C</button>
    <div
        contenteditable
        style="width: 500px; height: 500px; background-color: lightgrey; word-wrap:break-word;">
        <div>First Line#A</div>
        <div>First Line#B</div>
        First Line#C
        <div>First Line#D</div>
        <div>First Line#E</div>
    </div>
    <pre>
        节点编号：   节点名称：
        1   Element
        2   Attribute
        3   Text
        4   CDATA Section
        5   Entity Reference
        6   Entity
        7   Processing Instrucion
        8   Comment
        9   Document
        10  Document Type
        11  Document Fragment
        12  Notation

        ref: http://cqh520llr.iteye.com/blog/1881896
        ref: https://developer.mozilla.org/en-US/docs/Web/API/Text/splitText (splitText 把 textNode 拆開分別控制)
    </pre>
</body>
<script>
    // current Selection
    var select = getSelection();

    // this Editor
    var rootNode = document.querySelector('div');


    // start to make style
    var bClick = function(self){
        var range = select.getRangeAt(0);
        text = range.toString();
        var strong = document.createElement('strong');
        var editingFlag = range.cloneContents();
        debugger;
        // clearNode(editingFlag, strong)
        // strong.appendChild(editingFlag);
        // range.deleteContents();
        // range.insertNode(strong);
    };


    //
    var uClick = function(self){
        var range = select.getRangeAt(0);
        text = range.toString();
        var em = document.createElement('em');
        var editingFlag = range.cloneContents();
        em.appendChild(editingFlag, em);
        range.deleteContents();
        range.insertNode(em);
    };


    //
    var bClick2 = function(self){
        var color = '';

        if(bClick2.color){
            color = 'red';
        }
        else{
            color = 'blue';
        }
        bClick2.color = !bClick2.color;

        
        //
        var range = select.getRangeAt(0);
        var treeWalker = document.createTreeWalker(
            rootNode,
            NodeFilter.SHOW_TEXT
        );
        var nodeList = [];
        while(treeWalker.nextNode()) nodeList.push(treeWalker.currentNode);


        //
        var $s = nodeList.indexOf(range.startContainer);
        var $e = nodeList.indexOf(range.endContainer);


        // get all textNode, except startNode, endNode
        for(var i = $s; i <= $e; i++){
            if(i === $s){
                // 本來的值會變成前半段, 回傳被切割的後半段
                nodeList[i] = nodeList[i].splitText(range.startOffset);
            }

            if(i === $e){
                // 本來的值會變成前半段, 回傳後半段不處理
                nodeList[i].splitText(range.endOffset);
            }

            font = document.createElement('font');
            font.style.color = color;
            font.textContent = nodeList[i].nodeValue;
            nodeList[i].parentNode.insertBefore(font, nodeList[i]);
            nodeList[i].remove();
        }
    }
    bClick2.color = true;
</script>
</html>