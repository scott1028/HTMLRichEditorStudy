<!DOCTYPE html>
<html>

<head>
    <title></title>
</head>

<body>
    <div testdrop style="width: 50px; height: 50px; border-color: red; border-width: 1px; border-style: solid;"></div>
    <br />
    <button onclick="bClick(this)" style="color: red;">Change Color</button>
    <button onclick="uClick(this)">U</button>
    <button>C</button>
    <div contenteditable style="width: 600px; height: 100px; background-color: lightgrey; word-wrap:break-word; padding: 5px; overflow-y: auto;">
        <div></div>
<!--         <div>First Line#A</div>
        <div>First Line#B</div>
        First Line#C
        <div>First Line#D</div>
        <div>First Line#E</div> -->
    </div>
    <pre>
        节点编号：   节点名称：
        1   Element
        2   Attribute
        3   Text
        4   CDATA Section
        5   Entity Reference
        6   Entity
        7   Processing Instrucion
        8   Comment
        9   Document
        10  Document Type
        11  Document Fragment
        12  Notation

        ref: http://cqh520llr.iteye.com/blog/1881896
        ref: https://developer.mozilla.org/en-US/docs/Web/API/Text/splitText (splitText 把 textNode 拆開分別控制)
    </pre>
</body>
<script>
// this Editor
var rootNode = document.querySelector('div[contenteditable]');

//
var uClick = function(self) {
    var range = getSelection().getRangeAt(0);
    text = range.toString();
    var em = document.createElement('em');
    var editingFlag = range.cloneContents();
    em.appendChild(editingFlag, em);
    range.deleteContents();
    range.insertNode(em);
};


//
var bClick = function(self) {
    var color;

    if (bClick.color) {
        color = 'red';
        self.style.color = 'blue';
    } else {
        color = 'blue';
        self.style.color = 'red';
    }
    console.log('set to', color);
    bClick.color = !bClick.color;


    //
    var range = getSelection().getRangeAt(0);
    var treeWalker = document.createTreeWalker(
        rootNode,
        NodeFilter.SHOW_TEXT
    );
    var nodeList = [];
    while (treeWalker.nextNode()) nodeList.push(treeWalker.currentNode);


    //
    var $s = nodeList.indexOf(range.startContainer);
    var $e = nodeList.indexOf(range.endContainer);

    console.log($s, $e);
    debugger;


    // get all textNode, except startNode, endNode
    for (var i = $s; i <= $e; i++) {
        if (i === $s) {
            // 本來的值會變成前半段, 回傳被切割的後半段
            nodeList[i] = nodeList[i].splitText(range.startOffset);
        }

        if (i === $e) {
            // 本來的值會變成前半段, 回傳後半段不處理
            nodeList[i].splitText(range.endOffset);
        }

        font = document.createElement('font');
        font.style.color = color;
        font.textContent = nodeList[i].nodeValue;
        nodeList[i].parentNode.insertBefore(font, nodeList[i]);
        nodeList[i].remove();
    }


    // add clearNode Logic
    // clearNode();
}
bClick.color = true;
</script>
<script>
// start to make style
var bClickTest = function(self) {
    var range = getSelection().getRangeAt(0);
    text = range.toString();
    var strong = document.createElement('strong');
    var editingFlag = range.cloneContents();
    debugger;
    // clearNode(editingFlag, strong)
    // strong.appendChild(editingFlag);
    // range.deleteContents();
    // range.insertNode(strong);
};


//
var clearNode = function() {
    var node = rootNode;

    var treeWalker = document.createTreeWalker(
        rootNode,
        NodeFilter.SHOW_ELEMENT
    );
    var nodeList = [];
    while (treeWalker.nextNode()) nodeList.push(treeWalker.currentNode);



    for (var i = 0; i < nodeList.length; i++) {
        if (nodeList[i].textContent.length === 0) {
            // debugger;
            nodeList[i].remove();
        }
    }
}
</script>

<div debug>
    <font style="color: blue;">
        <font style="color: red;">
            <font style="color: blue;">
                <font style="color: red;">
                    <font style="color: blue;">
                        <font style="color: blue;">
                            <font style="color: red;">
                                <font style="color: blue;">
                                    <font style="color: red;">Fi
                                        <font style="color: blue;">rst Line#D</font>
                                    </font>
                                </font>
                            </font>
                        </font>
                    </font>
                </font>
            </font>
        </font>
    </font>
</div>

<script>
    document.querySelector('div[contenteditable]').onkeydown = function(e) {

        if(e.ctrlKey !== true){
            if(getSelection().getRangeAt(0).startContainer === document.querySelector('div[contenteditable]')){
                var p = document.createElement('p');
                var beforP = p.cloneNode();
                document.querySelector('div[contenteditable]').appendChild(beforP);
                beforP.focus();
            }


            // prevent default DIV for enter or wrap
            if(e.keyCode === 13){
                e.preventDefault();
                // getSelection().getRangeAt(0).startOffset

                // no select, press enter directly.
                if(getSelection().getRangeAt(0).startOffset === getSelection().getRangeAt(0).endOffset && getSelection().getRangeAt(0).startOffset > 0){
                    var afterTextNode = getSelection().getRangeAt(0).startContainer.splitText(getSelection().getRangeAt(0).startOffset);
                    var beforeTextNode = getSelection().getRangeAt(0).startContainer;
                    var parentNode = afterTextNode.parentNode;
                    var p = document.createElement('p');
                    var afterP = p.cloneNode();
                    var beforP = p.cloneNode();
                    afterP.appendChild(afterTextNode.cloneNode());
                    beforP.appendChild(beforeTextNode.cloneNode());
                    parentNode.insertBefore(beforP, beforeTextNode);
                    parentNode.insertBefore(afterP, afterTextNode);
                    afterTextNode.remove();
                    beforeTextNode.remove();                    
                };

            }
            console.log('preventDefault');
        }
    };
</script>
<script>
    document.querySelector('div[testdrop]').ondrop = function(e){
        console.log(2);
        e.preventDefault();
        console.log(e.dataTransfer.getData('text'));
    };

    document.querySelector('div[testdrop]').ondragover = function(e){
        e.preventDefault();
    };
</script>
</html>
